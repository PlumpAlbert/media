# vim:ft=yaml.docker-compose
version: "3"

networks:
  internal:
  proxy:
    name: "${NGINX_PROXY_NETWORK_NAME}"
    external: true

services:
  vpn:
    container_name: vpn
    image: qmcgaw/gluetun:latest
    restart: always
    networks:
      - proxy
      - internal
    cap_add:
      - NET_ADMIN
    ports:
      - 8888:8888 # HTTP proxy
      - 8388:8388 # Shadowsocks
    volumes:
      - ${ROOT}/vpn:/gluetun
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_VPN}"
      VIRTUAL_PATH: "${VIRTUAL_PATH_VPN}"
      VIRTUAL_PORT: 8888
    env_file:
      - stack.env

  radarr:
    build:
      context: .
      dockerfile: ./radarr/Dockerfile
    restart: unless-stopped
    depends_on:
      - vpn
      - torrent
      - prowlarr
    networks:
      - proxy
      - internal
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_RADARR}"
      VIRTUAL_PATH: "${VIRTUAL_PATH_RADARR}"
      VIRTUAL_PORT: 7878
    env_file:
      - stack.env
    volumes:
      - ${ROOT}/radarr:/config
      - ${MEDIA}:/data

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    restart: unless-stopped
    networks:
      - proxy
      - internal
    depends_on:
      - vpn
      - torrent
    env_file:
      - stack.env
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_PROWLARR}"
      VIRTUAL_PATH: "${VIRTUAL_PATH_PROWLARR}"
      VIRTUAL_PORT: 9696
    volumes:
      - ${ROOT}/prowlarr:/config

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    restart: unless-stopped
    networks:
      - proxy
      - internal
    depends_on:
      - vpn
      - torrent
      - prowlarr
    env_file:
      - stack.env
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_SONARR}"
      VIRTUAL_PATH: "${VIRTUAL_PATH_SONARR}"
      VIRTUAL_PORT: 8989
    volumes:
      - ${ROOT}/sonarr:/config
      - ${MEDIA}:/data

  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    restart: unless-stopped
    networks:
      - proxy
      - internal
    depends_on:
      - vpn
      - sonarr
      - radarr
      - plex
      - tautulli
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_OVERSEERR}"
      VIRTUAL_PORT: 5055
    volumes:
      - ${ROOT}/overseerr:/config

  torrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    restart: always
    networks:
      - proxy
      - internal
    depends_on:
      - vpn
    env_file:
      - stack.env
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_TORRENT}"
      VIRTUAL_PATH: "${VIRTUAL_PATH_TORRENT}"
      VIRTUAL_PORT: 8080
    volumes:
      - ${ROOT}/torrent:/config
      - ${MEDIA}/downloads:/downloads
      - ${MEDIA}/torrents:/torrents

  plex:
    image: lscr.io/linuxserver/plex:latest
    restart: always
    env_file:
      - stack.env
    networks:
      - proxy
      - internal
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_PLEX}"
      VIRTUAL_PATH: "${VIRTUAL_PATH_PLEX}"
      VIRTUAL_PORT: 32400
    volumes:
      - ${ROOT}/plex:/config
      - ${MEDIA}/series:/tv
      - ${MEDIA}/movies:/movies
      - ${MEDIA}/porn:/porn

  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    restart: always
    env_file:
      - stack.env
    networks:
      - proxy
      - internal
    environment:
      VIRTUAL_HOST: "${VIRTUAL_HOST_TAUTULLI}"
      VIRTUAL_PATH: "${VIRTUAL_PATH_TAUTULLI}"
      VIRTUAL_PORT: 32400
    volumes:
      - ${ROOT}/tautulli:/config
    ports:
      - 8181:8181
